name: Build and Deploy Wiki

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Axolotl-Wiki with submodules
      uses: actions/checkout@v4
      with:
        path: 'Axolotl-Wiki'
        submodules: 'recursive'
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Update submodules to latest
      run: |
        cd Axolotl-Wiki
        git submodule update --remote --recursive
    
    - name: Checkout Allay
      uses: actions/checkout@v4
      with:
        repository: PKUSoftwareEngineeringTeam/Allay
        path: 'Allay'
    
    - name: Setup Rust
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: stable
    
    - name: Build with Allay
      run: |
        cd Allay
        cargo run --bin=allay -- build --root=../Axolotl-Wiki
    
    - name: Checkout Axolotl-Wiki-Pages
      uses: actions/checkout@v4
      with:
        repository: PKUSoftwareEngineeringTeam/Axolotl-Wiki-Pages
        path: 'Axolotl-Wiki-Pages'
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Sync generated files
      run: |
        cd Axolotl-Wiki-Pages
        find . -maxdepth 1 ! -name '.git' ! -name '.' -exec rm -rf {} +
        
        cp -r ../Axolotl-Wiki/public/* ./
        
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        
        git add .
        git commit -m "Auto-deploy: Update wiki content $(date +'%Y-%m-%d %H:%M:%S')" || echo "No changes to commit"
    
    - name: Push to Axolotl-Wiki-Pages
      run: |
        cd Axolotl-Wiki-Pages
        git push origin main