## Allay 模板引擎用户指南

### 基本语法

在 Allay 模板中，使用以下标记：

- `{- -}`：命令块，用于控制流程
- `{: :}`：表达式块，用于输出内容
- `{< >}`：短代码块，用于扩展功能
- `{{ }}`：不转义文本块，用于原样输出

所有表达式块都会被求值并替换为其结果。

### 变量和表达式

#### 变量定义和使用

```html
{- set $name = "Allay" -}
{- set $count = 10 -}
{: $name :} <!-- 输出: Allay -->
{: $count + 5 :} <!-- 输出: 15 -->
```

#### 字段访问

```html
{- set $user = .current_user -}
{: $user.name :}        <!-- 访问 name 字段 -->
{: $user.profile.age :} <!-- 嵌套字段访问 -->
{: .title :}            <!-- 访问当前作用域的 title 字段 -->
```

#### 表达式支持

Allay 支持丰富的表达式：

```html
<!-- 算术运算 -->
{: 10 + 5 :}     <!-- 15 -->
{: $price * 1.1 :} <!-- 价格加 10% -->

<!-- 比较运算 -->
{- if $score >= 60 -}及格{- end -}
{- if $name == "admin" -}管理员{- end -}

<!-- 逻辑运算 -->
{- if $logged_in && $is_admin -}欢迎管理员{- end -}
{- if !$visible -}隐藏内容{- end -}

<!-- 字符串操作 -->
{: "Hello " + $name + "!" :}
```

### 控制流程命令

#### `set` - 变量赋值

在当前作用域创建或修改变量。

```html
{- set $title = .page_title -}
{- set $count = $count + 1 -}
{- set $full_name = $first_name + " " + $last_name -}
<h1>{: $title :}</h1>
```

#### `for` - 循环遍历

遍历列表或集合，支持索引变量。

```html
<!-- 基本遍历 -->
<ul>
    {- for $item: .products -}
    <li>{: $item.name :} - ${: $item.price :}</li>
    {- end -}
</ul>

<!-- 带索引的遍历 -->
<ol>
    {- for $product, $index: .products -}
    <li>{: $index + 1 :}. {: $product.name :}</li>
    {- end -}
</ol>

<!-- 遍历对象字段 -->
{- for $key, $value: .settings -}
<p>{: $key :}: {: $value :}</p>
{- end -}
```

#### `if` / `else` - 条件判断

根据条件渲染不同内容。

```html
<!-- 简单条件 -->
{- if .user.is_admin -}
<button>管理面板</button>
{- end -}

<!-- 条件分支 -->
{- if .score >= 90 -}
<p>优秀</p>
{- else if .score >= 60 -}
<p>及格</p>
{- else -}
<p>不及格</p>
{- end -}

<!-- 复杂条件 -->
{- if .user.logged_in && (.user.role == "admin" || .user.role == "editor") -}
<p>欢迎，{: .user.name :}</p>
{- end -}
```

#### `with` - 作用域切换

进入对象的作用域，简化字段访问。

```html
<!-- 不使用 with -->
{: .article.author.name :}
{: .article.author.email :}

<!-- 使用 with 简化 -->
{- with .article.author -}
<p>作者: {: .name :}</p>
<p>邮箱: {: .email :}</p>
{- end -}

<!-- 安全使用（对象可能为空） -->
{- with .optional_content || {} -}
<div>{: .text :}</div>
{- end -}
```

### 模板组织和复用

#### `include` - 模板包含

包含其他模板文件，支持参数传递。

```html
<!-- 包含头部模板，使用当前作用域 -->
{- include "header.html" -}

<!-- 包含文章模板，传递特定作用域和参数 -->
{- include "components/article.html" .current_article "特色文章" -}

<!-- 包含侧边栏，不传递作用域（使用当前作用域） -->
{- include "sidebar.html" -}
```

在被包含的模板中，使用 `param` 访问传递的参数：

```html
<!-- components/article.html -->
<article class="article">
    <h2>{: .title :}</h2>
    <div class="meta">{: param.0 :}</div> <!-- 显示 "特色文章" -->
    <div class="content">{: .content :}</div>
</article>
```

#### 短代码系统

短代码用于扩展模板功能，支持单标签和块级用法。

```html
<!-- 单标签短代码 -->
{< image src="photo.jpg" alt="描述" />}

<!-- 块级短代码 -->
{< panel title="提示" >}
这是一个重要的提示信息。
{</ panel >}

<!-- 带参数的短代码 -->
{< embed url=$video_url autoplay=true />}
```

### 特殊变量和作用域

#### 内置变量

```html
{: this :}        <!-- 当前作用域对象 -->
{: site.title :}  <!-- 站点全局变量 -->
{: pages :}       <!-- 页面集合 -->
{: param.0 :}     <!-- 第一个参数 -->
{: param.1 :}     <!-- 第二个参数 -->
```

#### 作用域规则

```html
<!-- 全局作用域 -->
{- set $global_var = "可在任何地方访问" -}

<!-- 循环内的作用域 -->
{- for $item: .items -}
    {- set $local_var = "只在循环内有效" -}
    {: $local_var :} <!-- 正常 -->
{- end -}
{: $local_var :} <!-- 错误，变量不存在 -->

<!-- with 块内的修改 -->
{- with .user -}
    {- set $temp = .name -} <!-- 不影响原对象 -->
{- end -}
```

### 实用技巧和最佳实践

#### 1. 安全访问嵌套字段

```html
<!-- 安全的方式访问可能不存在的字段 -->
{- with .user || {} -}
{: .profile?.avatar || "default.jpg" :}
{- end -}
```

#### 2. 使用默认值

```html
{: $username || "匿名用户" :}
{: .description || "暂无描述" :}
```

#### 3. 条件包含模板

```html
{- if .show_sidebar -}
{- include "sidebar.html" -}
{- end -}
```

#### 4. 循环中的状态判断

```html
{- for $item, $index: .items -}
{- if $index == 0 -}
<li class="first">{: $item :}</li>
{- else if $index == count(.items) - 1 -}
<li class="last">{: $item :}</li>
{- else -}
<li>{: $item :}</li>
{- end -}
{- end -}
```

#### 5. 模板注释

```html
{- 这是单行注释 -}

{-
  这是多行注释
  不会在最终输出中显示
-}
```

### 错误处理

#### 常见错误及解决

```html
<!-- 错误：变量不存在 -->
{: $undefined_var :} <!-- 会抛出错误 -->

<!-- 正确：使用默认值 -->
{: $undefined_var || "默认值" :}

<!-- 错误：除零 -->
{: 10 / 0 :} <!-- 会抛出错误 -->

<!-- 正确：安全检查 -->
{- if $divisor != 0 -}{: 10 / $divisor :}{- end -}
```


如果你想要更详细的说明，以下是博客引擎支持的所有语法规则的参考表格：

### 基本语法结构

| 语法类别 | 语法名称 | 语法格式 | 描述 | 示例 |
|---------|---------|---------|------|------|
| **文件结构** | 文件 | `SOI ~ (yaml_front_matter \| toml_front_matter)? ~ template ~ EOI` | 完整文件结构，包含可选的元数据和模板内容 | - |
| **元数据** | YAML 前置元数据 | `---\n` + 内容 + `---\n` | 使用 YAML 格式的元数据块 | `---\ntitle: 示例\n---` |
| | TOML 前置元数据 | `+++\n` + 内容 + `+++\n` | 使用 TOML 格式的元数据块 | `+++\ntitle = "示例"\n+++` |

### 模板控制结构

| 语法类别 | 语法名称 | 语法格式 | 描述 | 示例 |
|---------|---------|---------|------|------|
| **文本处理** | 普通文本 | `(!("{-" \| "{<" \| "{:" \| "{{") ~ ANY)+` | 普通文本内容，不包含特殊语法 | `这是一段普通文本` |
| | 不转义文本 | `{{` + 内容 + `}}` | 原样输出内容，不进行转义 | `{{<html>}}` 输出 `<html>` |
| **变量和表达式** | 变量 | `$` + 标识符 | 变量引用 | `$title` |
| | 字段访问 | 顶级对象 + `.` + 字段 | 访问对象的字段 | `$user.name` |
| | 字符串 | `"` + 内容 + `"` | 字符串字面量 | `"Hello World"` |
| | 布尔值 | `#t` 或 `#f` | 布尔值字面量 | `#t` (true), `#f` (false) |
| | 空值 | `null` | 空值字面量 | `null` |
| | 数字 | 数字序列 | 数字字面量 | `123`, `45.67` |

### 控制命令

| 语法类别 | 语法名称 | 语法格式 | 描述 | 示例 |
|---------|---------|---------|------|------|
| **变量设置** | set 命令 | `{- set 变量 = 表达式 -}` | 设置变量值 | `{- set $name = "John" -}` |
| **循环控制** | for 循环 | `{- for 变量[,变量] : 表达式 -}` + 内容 + `{- end -}` | 遍历集合 | `{- for $item : $list -}{$item}{- end -}` |
| **条件控制** | if 条件 | `{- if 表达式 -}` + 内容 + (`{- else -}` + 内容)? + `{- end -}` | 条件判断 | `{- if $show -}显示内容{- end -}` |
| **作用域控制** | with 块 | `{- with 表达式 -}` + 内容 + `{- end -}` | 创建新的作用域 | `{- with $user -}{.name}{- end -}` |
| **文件包含** | include 命令 | `{- include "文件名" 参数... -}` | 包含其他模板文件 | `{- include "header.html" -}` |

### 短代码系统

| 语法类别 | 语法名称 | 语法格式 | 描述 | 示例 |
|---------|---------|---------|------|------|
| **短代码** | 单标签短代码 | `{< 名称 参数... />}` | 自闭合的短代码 | `{< image src="pic.jpg" />}` |
| | 块级短代码 | `{< 名称 参数... >}` + 内容 + `{</ 名称 >}` | 包含内容的短代码 | `{< panel >}内容{</ panel >}` |

### 内容替换

| 语法类别 | 语法名称 | 语法格式 | 描述 | 示例 |
|---------|---------|---------|------|------|
| **内容替换** | 表达式替换 | `{:` + 表达式 + `:}` | 计算并输出表达式结果 | `{:$a + $b:}` |
| | get 替换 | `{:` + `get` + 表达式 + `:}` | 显式获取并输出值 | `{:$user.name:}` |

### 操作符

| 操作符类型 | 操作符 | 描述 | 优先级 |
|----------|--------|------|--------|
| **逻辑操作符** | `&&` | 逻辑与 | 低 |
| | `\|\|` | 逻辑或 | 低 |
| **比较操作符** | `==`, `!=`, `<`, `>`, `<=`, `>=` | 比较运算 | 中 |
| **算术操作符** | `+`, `-` | 加减法 | 中 |
| | `*`, `/`, `%` | 乘除取模 | 高 |
| **一元操作符** | `!`, `+`, `-` | 逻辑非、正负号 | 最高 |

### 特殊关键字

| 关键字 | 描述 |
|--------|------|
| `this` | 引用当前上下文对象 |
| `param` | 引用模板参数 |
| `site` | 引用站点全局变量 |
| `pages` | 引用页面集合 |
